# Pinsheet Scanner

Extract 9-pin bowling (Kegeln) scores from scanned score sheets using computer vision and deep learning.

## Features

- **YOLO pin diagram detection** with classical blob-analysis fallback
- **CNN pin state classification** — 3-layer backbone + spatial extraction + TTA (~60K params)
- **OCR cross-validation** — optional parallel Tesseract verification (`--ocr`)
- **Sheet preprocessing** — perspective correction and CLAHE contrast normalisation
- **Browser-based labeling UI** — disagreements-first sort, pin overlay on image
- **Hyperparameter tuning** — Optuna search with cosine-warmup schedule
- **~400 ms/sheet** without OCR, ~800 ms with OCR

## Pin Layout

```
      8           (back)
    6   7
  3   4   5
    1   2
      0           (front)
```

## Installation

Requires Python 3.13+ and [uv](https://docs.astral.sh/uv/).

```bash
uv sync                   # core dependencies
uv sync --extra dev       # + pytest, ruff
uv sync --extra ocr       # + pytesseract (optional)
```

## Quick Start

```bash
just scan sheets/001.jpeg             # scan a single sheet
just scan sheets/*                    # scan all sheets
just scan sheets/001.jpeg --ocr       # with OCR cross-validation
just collect sheets/*                 # harvest training crops from all sheets
just collect sheets/* --overwrite     # refresh pseudo-labels after retraining
just label                            # label ground truth (browser UI)
just tune                             # hyperparameter search (20 trials)
just train                            # k-fold cross-validate + retrain
just accuracy                         # full dataset accuracy
just accuracy --manual-only           # hand-labeled crops only
```

## Project Structure

```
sheets/                    input score sheet photos
data/
  classifier/
    crops/                 pin diagram crop images (generated by collect)
    labels.csv             ground truth labels (manual + pseudo)
  detector/
    dataset.yaml           YOLO dataset config
    train/                 YOLO training images + labels
    val/                   YOLO validation images + labels
models/
  pin_diagram.pt           YOLO detector weights
  pin_classifier.pt        CNN classifier weights
  hyperparams.json         tuned training hyperparameters
src/
  pipeline.py              orchestrates the full flow (model LRU cache)
  preprocess.py            perspective correction + CLAHE
  detect.py                YOLO detection (classical fallback if < 10 boxes)
  classify.py              PinClassifier CNN + 5-pass TTA
  ocr.py                   optional parallel Tesseract cross-validation
  model.py                 PinClassifier architecture
  training.py              training loop, cross-validation, augmentation config
  augment.py               13-transform augmentation pipeline
  labels.py                label CSV I/O
  cli.py                   CLI commands (typer)
  labeler.html             browser labeling UI
```

## Architecture

```
raw photo
  → preprocess.py    perspective correction + CLAHE
  → detect.py        YOLO detection (classical fallback if < 10 boxes)
  → classify.py      PinClassifier CNN + 5-pass TTA
  → ocr.py           optional parallel Tesseract cross-validation
  → pipeline.py      orchestrates the full flow (model LRU cache)
```

### PinClassifier

Shared-backbone CNN with spatial pin extraction and global context.
Three conv layers (1→32→64→64, all 3×3, padding-preserving) build a
64-channel feature map at full 64×64 resolution. For each of the 9 pin
positions, a 16×16 patch is extracted from the feature map and average-pooled
to a 64-dim local vector. A global average pool gives a 64-dim context vector.
Local + global are concatenated (128-dim) and fed to a shared 2-layer head
(128→32→1). Total: ~60K parameters.

### CLI Commands

| Command | Description |
|---------|-------------|
| `scan IMAGES...` | Scan sheet(s), print per-throw results and Bahn summaries |
| `collect IMAGES...` | Harvest high-confidence crops into the training set |
| `extract IMAGE` | Extract pin diagram crops for inspection |
| `label` | Browser labeling UI (disagreements first) |
| `train` | K-fold cross-validate + retrain CNN (auto-backup old weights) |
| `tune` | Optuna hyperparameter search (saves provenance metadata) |
| `train-detector` | Train YOLO detector |
| `accuracy` | Validate predictions against labels |

## Development

```bash
just test           # unit tests
just lint           # ruff check + format
just integration    # end-to-end tests (requires model weights)
```
