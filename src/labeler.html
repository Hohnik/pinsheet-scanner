<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pin Labeler</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: system-ui, -apple-system, sans-serif;
    background: #0e0e0e;
    color: #ccc;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px 16px;
    gap: 10px;
    user-select: none;
  }

  /* ── Top bar: filename  ·  position counter  ·  speed ───────────────── */
  .topbar {
    width: 320px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    font-size: 0.75rem;
  }
  .tb-name {
    font-family: monospace;
    color: #444;
    max-width: 180px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .tb-name.is-labeled { color: #3c9; }

  .tb-right {
    text-align: right;
    line-height: 1.6;
    color: #444;
    white-space: nowrap;
  }
  .tb-right .speed { color: #555; }

  /* ── Progress bar ────────────────────────────────────────────────────── */
  .progress-bar {
    width: 320px;
    height: 2px;
    background: #1a1a1a;
    border-radius: 1px;
  }
  .progress-fill {
    height: 100%;
    background: #2e6fff;
    border-radius: 1px;
    transition: width 0.35s ease;
  }

  /* ── Image + pin dot overlay ─────────────────────────────────────────── */
  /*
     The img-wrap is fixed 300×300 so percentage-based pin positions always
     map to the same spot regardless of the underlying image load state.
     Pin positions (PIN_FRAC) are derived from model.py PIN_COORDS / 64.
  */
  .img-wrap {
    position: relative;
    width: 300px;
    height: 300px;
    flex-shrink: 0;
  }
  .crop-img {
    width: 300px;
    height: 300px;
    image-rendering: pixelated;
    display: block;
    border-radius: 4px;
    border: 1px solid #1a1a1a;
  }

  /* Clickable circles overlaid at exact pin positions */
  .pin-dot {
    position: absolute;
    width: 34px;
    height: 34px;
    border-radius: 50%;
    /* centre the dot on the pin coordinate */
    transform: translate(-50%, -50%);
    cursor: pointer;
    border: 2px solid rgba(255, 255, 255, 0.12);
    background: transparent;
    transition: background 0.08s, border-color 0.08s;
  }
  .pin-dot:hover { border-color: rgba(255, 255, 255, 0.35); }
  .pin-dot.down {
    background: rgba(46, 111, 255, 0.45);
    border-color: rgba(100, 160, 255, 0.9);
  }

  /* ── Large score readout ─────────────────────────────────────────────── */
  .score {
    font-size: 2.2rem;
    font-weight: 700;
    color: #2e6fff;
    font-variant-numeric: tabular-nums;
    line-height: 1;
  }

  /* ── Navigation buttons ──────────────────────────────────────────────── */
  .nav { display: flex; gap: 8px; }
  .nav button {
    padding: 9px 32px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    transition: background 0.1s, opacity 0.1s;
  }
  .btn-prev { background: #1c1c1c; color: #555; }
  .btn-prev:not(:disabled):hover { background: #242424; color: #999; }
  .btn-prev:disabled { opacity: 0.2; cursor: default; }
  .btn-next { background: #2e6fff; color: #fff; letter-spacing: 0.02em; }
  .btn-next:hover { background: #4880ff; }

  /* ── Status flash ────────────────────────────────────────────────────── */
  .status {
    height: 1em;
    font-size: 0.72rem;
    color: #3c9;
    transition: opacity 0.4s;
  }

  /* ── Footer hint ─────────────────────────────────────────────────────── */
  .keys { font-size: 0.6rem; color: #222; letter-spacing: 0.02em; }
</style>
</head>
<body>

<!-- Stats bar -->
<div class="topbar">
  <span class="tb-name" id="tb-name">—</span>
  <div class="tb-right">
    <div id="tb-pos">— / —</div>
    <div class="speed" id="tb-speed"></div>
  </div>
</div>

<!-- Progress -->
<div class="progress-bar">
  <div class="progress-fill" id="prog"></div>
</div>

<!-- Crop image with pin overlay (dots injected by JS) -->
<div class="img-wrap" id="img-wrap">
  <img class="crop-img" id="crop-img" src="" alt="crop">
</div>

<!-- Pin-count score -->
<div class="score" id="score">0</div>

<!-- Navigation (both buttons save first) -->
<div class="nav">
  <button class="btn-prev" id="btn-prev">← Back</button>
  <button class="btn-next" id="btn-next">Next →</button>
</div>

<div class="status" id="status"></div>
<div class="keys">← → &nbsp;save &amp; navigate &nbsp;·&nbsp; Enter = next &nbsp;·&nbsp; click a dot to toggle pin</div>

<script>
// ── Data injected server-side ─────────────────────────────────────────────
// Crops are pre-sorted: unlabeled first (ascending CNN confidence), then labeled.
const CROPS       = /*CROPS_JSON*/;
const PREDICTIONS = /*PREDICTIONS_JSON*/;
const LABELS      = /*LABELS_JSON*/;

// ── Pin positions ─────────────────────────────────────────────────────────
// Derived from model.py PIN_COORDS (cx, cy) / 64  →  fraction of image size.
// Layout (front = 0, back = 8):
//        8
//      6   7
//    3   4   5
//      1   2
//        0
const PIN_FRAC = [
  [32 / 64, 56 / 64],  // 0  front
  [20 / 64, 44 / 64],  // 1
  [44 / 64, 44 / 64],  // 2
  [ 8 / 64, 32 / 64],  // 3
  [32 / 64, 32 / 64],  // 4
  [56 / 64, 32 / 64],  // 5
  [20 / 64, 20 / 64],  // 6
  [44 / 64, 20 / 64],  // 7
  [32 / 64,  8 / 64],  // 8  back
];

// ── Session state ─────────────────────────────────────────────────────────
let idx = (() => {
  for (let i = 0; i < CROPS.length; i++) {
    if (!LABELS[CROPS[i]]) return i;
  }
  return 0; // all labeled → start at 0
})();

let pins         = Array(9).fill(0);
let sessionStart = null;   // set on first save
let sessionSaves = 0;
let statusTimer  = null;

// ── Helpers ───────────────────────────────────────────────────────────────

function labeledCount() { return Object.keys(LABELS).length; }

function getInitialPins(name) {
  if (LABELS[name]) return [...LABELS[name]];
  const p = PREDICTIONS[name];
  return p ? [...p.pins] : Array(9).fill(0);
}

// ── Pin overlay ───────────────────────────────────────────────────────────

function buildPinDots() {
  document.querySelectorAll(".pin-dot").forEach(e => e.remove());
  const wrap = document.getElementById("img-wrap");
  for (let i = 0; i < 9; i++) {
    const [fx, fy] = PIN_FRAC[i];
    const dot = document.createElement("div");
    dot.className = "pin-dot" + (pins[i] ? " down" : "");
    dot.id = "p" + i;
    // percentage positioning relative to img-wrap (300×300 px)
    dot.style.left = (fx * 100).toFixed(3) + "%";
    dot.style.top  = (fy * 100).toFixed(3) + "%";
    const pi = i;
    dot.addEventListener("click", e => { e.stopPropagation(); togglePin(pi); });
    wrap.appendChild(dot);
  }
}

function togglePin(i) {
  pins[i] ^= 1;
  document.getElementById("p" + i).classList.toggle("down", !!pins[i]);
  document.getElementById("score").textContent = pins.reduce((a, b) => a + b, 0);
}

// ── Render ────────────────────────────────────────────────────────────────

function render() {
  const name  = CROPS[idx];
  const n     = CROPS.length;
  const done  = labeledCount();
  const isLabeled = !!LABELS[name];

  pins = getInitialPins(name);

  // Topbar
  const tbName = document.getElementById("tb-name");
  tbName.textContent = name + (isLabeled ? " ✓" : "");
  tbName.className = "tb-name" + (isLabeled ? " is-labeled" : "");

  document.getElementById("tb-pos").textContent =
    `${idx + 1} / ${n}  ·  ${done} labeled`;

  // Progress bar
  document.getElementById("prog").style.width = (done / n * 100).toFixed(2) + "%";

  // Image
  document.getElementById("crop-img").src = "/crop/" + name;

  // Score
  document.getElementById("score").textContent = pins.reduce((a, b) => a + b, 0);

  // Nav
  document.getElementById("btn-prev").disabled = idx === 0;
  document.getElementById("btn-next").disabled = idx >= n - 1;

  // Pin overlay
  buildPinDots();
}

// ── Speed ticker (runs every 500 ms) ─────────────────────────────────────

setInterval(() => {
  if (!sessionStart || sessionSaves === 0) return;
  const s = (Date.now() - sessionStart) / 1000;
  document.getElementById("tb-speed").textContent =
    (sessionSaves / s).toFixed(1) + " /s";
}, 500);

// ── Save + navigate ───────────────────────────────────────────────────────

async function saveAndGo(delta) {
  const name = CROPS[idx];
  if (!sessionStart) sessionStart = Date.now();

  try {
    const r = await fetch("/save", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ filename: name, pins: [...pins] }),
    });
    if (!r.ok) throw new Error(r.statusText);
    LABELS[name] = [...pins];
    sessionSaves++;
    flash("✓");
  } catch (e) {
    flash("Error: " + e.message, true);
    return; // don't navigate on save failure
  }

  const next = idx + delta;
  if (next >= 0 && next < CROPS.length) {
    idx = next;
  }
  render();
}

function flash(msg, err = false) {
  const el = document.getElementById("status");
  el.textContent = msg;
  el.style.color   = err ? "#f55" : "#3c9";
  el.style.opacity = "1";
  clearTimeout(statusTimer);
  statusTimer = setTimeout(() => { el.style.opacity = "0"; }, 1200);
}

// ── Keyboard ──────────────────────────────────────────────────────────────

document.addEventListener("keydown", e => {
  if (e.key === "ArrowRight" || e.key === "Enter") {
    e.preventDefault();
    saveAndGo(1);
  } else if (e.key === "ArrowLeft") {
    e.preventDefault();
    saveAndGo(-1);
  }
});

document.getElementById("btn-next").addEventListener("click", () => saveAndGo(1));
document.getElementById("btn-prev").addEventListener("click", () => saveAndGo(-1));

// ── Boot ──────────────────────────────────────────────────────────────────

render();
</script>
</body>
</html>
