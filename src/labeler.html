<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pin Labeler</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
         background: #1a1a2e; color: #e0e0e0; display: flex; flex-direction: column;
         align-items: center; min-height: 100vh; padding: 20px; }
  h1 { font-size: 1.3rem; margin-bottom: 8px; color: #a0a0c0; font-weight: 500; }
  .progress { font-size: 0.85rem; color: #707090; margin-bottom: 16px; }
  .progress-bar { width: 320px; height: 4px; background: #2a2a4a; border-radius: 2px;
                  margin-bottom: 20px; }
  .progress-fill { height: 100%; background: #6c63ff; border-radius: 2px; transition: width 0.3s; }
  .card { background: #16213e; border-radius: 12px; padding: 24px; width: 360px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.3); }
  .crop-name { text-align: center; font-size: 0.9rem; color: #8888aa; margin-bottom: 12px;
               font-family: monospace; }
  .crop-container { display: flex; justify-content: center; margin-bottom: 20px; }
  .crop-container img { width: 200px; height: auto; image-rendering: pixelated;
                        border-radius: 6px; border: 2px solid #2a2a4a; }
  .pin-grid { position: relative; width: 220px; height: 220px; margin: 0 auto 20px; }
  .pin { position: absolute; width: 40px; height: 40px; border-radius: 50%;
         border: 3px solid #4a4a6a; background: transparent; cursor: pointer;
         display: flex; align-items: center; justify-content: center;
         font-size: 0.75rem; font-weight: 600; color: #6a6a8a;
         transition: all 0.15s ease; transform: translate(-50%, -50%); }
  .pin:hover { border-color: #6c63ff; transform: translate(-50%, -50%) scale(1.1); }
  .pin.down { background: #6c63ff; border-color: #6c63ff; color: #fff; }
  .pin .key-hint { position: absolute; bottom: -16px; font-size: 0.6rem; color: #505070; }
  .nav { display: flex; gap: 10px; justify-content: center; margin-bottom: 12px; }
  .nav button { padding: 8px 20px; border: none; border-radius: 6px; cursor: pointer;
                font-size: 0.85rem; font-weight: 500; transition: background 0.15s; }
  .btn-prev, .btn-next { background: #2a2a4a; color: #c0c0d0; }
  .btn-prev:hover, .btn-next:hover { background: #3a3a5a; }
  .btn-save { background: #6c63ff; color: #fff; }
  .btn-save:hover { background: #5a52dd; }
  .btn-prev:disabled, .btn-next:disabled { opacity: 0.3; cursor: default; }
  .score { text-align: center; font-size: 1.1rem; color: #6c63ff; margin-bottom: 12px;
           font-weight: 600; }
  .conf { text-align: center; font-size: 0.75rem; color: #505070; margin-bottom: 16px; }
  .status { text-align: center; font-size: 0.8rem; margin-top: 12px; min-height: 1.2em; }
  .status.saved { color: #4caf50; }
  .status.error { color: #f44336; }
  .labeled-mark { color: #4caf50; font-size: 0.75rem; }
  .keyboard-help { font-size: 0.7rem; color: #404060; text-align: center;
                   margin-top: 16px; line-height: 1.6; }
</style>
</head>
<body>
<h1>Pin Labeler</h1>
<div class="progress" id="progress-text"></div>
<div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
<div class="card" id="card"></div>
<div class="keyboard-help">
  <b>Keys:</b> 1-9 toggle pins &middot; &larr;&rarr; navigate &middot; Enter save &amp; next
</div>

<script>
// Injected server-side — crops are pre-sorted by ascending CNN confidence
// (unlabeled first, lowest-confidence first) so each session targets the
// examples the model is most uncertain about.
const CROPS = /*CROPS_JSON*/;
const PREDICTIONS = /*PREDICTIONS_JSON*/;
const LABELS = /*LABELS_JSON*/;

// Start at the first unlabeled crop (front of sorted list).
let idx = 0;
for (let i = 0; i < CROPS.length; i++) {
  if (!LABELS[CROPS[i]]) { idx = i; break; }
}

// Pin positions — bottom-to-top numbering (0 = front, 8 = back).
const PIN_POS = [
  [50, 96],  // 0 – front / bottom
  [30, 74],  // 1 – 2nd row from bottom, left
  [70, 74],  // 2 – 2nd row from bottom, right
  [10, 52],  // 3 – middle row, left
  [50, 52],  // 4 – middle row, centre
  [90, 52],  // 5 – middle row, right
  [30, 30],  // 6 – 2nd row from top, left
  [70, 30],  // 7 – 2nd row from top, right
  [50,  8],  // 8 – back / top
];

let pins = [0,0,0,0,0,0,0,0,0];

function getInitialPins(name) {
  if (LABELS[name]) return [...LABELS[name]];
  if (PREDICTIONS[name]) return [...PREDICTIONS[name].pins];
  return [0,0,0,0,0,0,0,0,0];
}

function render() {
  const total = CROPS.length;
  const labeled = Object.keys(LABELS).length;
  document.getElementById("progress-text").textContent =
    `${labeled} / ${total} labeled` + (labeled === total ? " ✓" : "");
  document.getElementById("progress-fill").style.width =
    `${(labeled / total * 100).toFixed(1)}%`;

  if (total === 0) {
    document.getElementById("card").innerHTML = '<div style="text-align:center;padding:40px"><h2 style="color:#4caf50">No crops found</h2></div>';
    return;
  }

  const name = CROPS[idx];
  pins = getInitialPins(name);
  const pred = PREDICTIONS[name];
  const isLabeled = !!LABELS[name];

  let html = `<div class="crop-name">${name} ${isLabeled ? '<span class="labeled-mark">✓</span>' : ''}</div>`;
  html += `<div class="crop-container"><img src="/crop/${name}" alt="${name}"></div>`;
  html += `<div class="score" id="score">Score: ${pins.reduce((a,b)=>a+b,0)}</div>`;
  if (pred) html += `<div class="conf">CNN confidence: ${(pred.conf * 100).toFixed(0)}%</div>`;
  html += `<div class="pin-grid">`;
  for (let i = 0; i < 9; i++) {
    const [x, y] = PIN_POS[i];
    html += `<div class="pin ${pins[i] ? 'down' : ''}" style="left:${x}%;top:${y}%"
                  onclick="togglePin(${i})" id="pin${i}">
               ${i}<span class="key-hint">${i+1}</span>
             </div>`;
  }
  html += `</div>`;
  html += `<div class="nav">
    <button class="btn-prev" onclick="go(-1)" ${idx===0?'disabled':''}>← Prev</button>
    <button class="btn-save" onclick="saveAndNext()">Save & Next</button>
    <button class="btn-next" onclick="go(1)" ${idx>=total-1?'disabled':''}>Next →</button>
  </div>`;
  html += `<div class="status" id="status"></div>`;
  document.getElementById("card").innerHTML = html;
}

function togglePin(i) {
  pins[i] = pins[i] ? 0 : 1;
  document.getElementById("pin" + i).classList.toggle("down", !!pins[i]);
  document.getElementById("score").textContent = "Score: " + pins.reduce((a,b)=>a+b,0);
}

function go(delta) {
  const next = idx + delta;
  if (next >= 0 && next < CROPS.length) { idx = next; render(); }
}

async function saveAndNext() {
  const name = CROPS[idx];
  const body = JSON.stringify({ filename: name, pins: [...pins] });
  try {
    const resp = await fetch("/save", {
      method: "POST", headers: {"Content-Type":"application/json"}, body
    });
    if (!resp.ok) throw new Error(resp.statusText);
    LABELS[name] = [...pins];
    const el = document.getElementById("status");
    el.textContent = "Saved ✓"; el.className = "status saved";
    setTimeout(() => {
      if (idx < CROPS.length - 1) { idx++; render(); }
      else { render(); el.textContent = "All done!"; el.className = "status saved"; }
    }, 250);
  } catch (e) {
    const el = document.getElementById("status");
    el.textContent = "Error: " + e.message; el.className = "status error";
  }
}

document.addEventListener("keydown", (e) => {
  if (e.key === "ArrowLeft") go(-1);
  else if (e.key === "ArrowRight") go(1);
  else if (e.key === "Enter") saveAndNext();
  else if (e.key >= "1" && e.key <= "9") togglePin(parseInt(e.key) - 1);
});

render();
</script>
</body>
</html>
